---
title: "Taller 02. Visualización de datos con ggplot2"
date: "`r format(Sys.Date(), '%d/%m/%Y')`"
output:
  pdf_document: default
  html_document:
    df_print: paged
editor_options: 
  markdown: 
    wrap: 72
---

```{r include = FALSE, message = FALSE, warning = FALSE, error = FALSE}
library(knitr)
opts_chunk$set(collapse = TRUE)
```

# 1. Introducción

En este taller aprenderemos el uso del paquete `ggplot2`, un paquete de R basado en la gramática de gráficos que permite visualizar datos de una manera consistente y estructurada. Para hacer más versátil su uso, se recomienda conocer el funcionamiento del paquete dplyr y el uso de tuberías (pipes `%>%`). `ggplot2` no está contenido en la librería tidyverse. Por eso, hay que instalarlo de forma separada. `tidiverse` sí incluye otros paquetes como dplyr que, a su vez, incluye los pipes (`%>%`). Para más detalles sobre `tidyverse` puede ir al Taller de Introducción a R y RStudio.


# 2. Objetivos

- Reconocer las funciones que componen el paquete `ggplot2`
- Realizar gráficos básicos con la estructura de `ggplot2`



# 3. Tabla de contenido
- Tema 1: Visualización
- Tema 2: Estética (Aesthetics)
- Tema 3: Geometría (Geometry)
- Tema 4: Escala (Scale)
- Tema 5: Facetas (Facets)
- Tema 6: Tema (Theme)



# 4. Temas

## Tema 1: Visualización

### 1.1. Principios de la gramática de gráficos con `ggplot2`

`ggplot2` es un paquete de R basado en la gramática de gráficos que permite visualizar datos de una manera consistente y estructurada.

`ggplot2` recibe su nombre precisamente de la abreviación del término *gramática de gráficos* (gg). 
La *gramática de los gráficos* se refiere a un enfoque conceptual propuesto y desarrollado por Leland Wilkinson para la creación de gráficos, el cual sirvió como base para el desarrollo de `ggplot2` a manos de Hadley Wickham. 

La gramática de los gráficos proporciona un marco conceptual para pensar sobre cómo construir y entender visualizaciones de datos de una manera coherente y estructurada. En términos simples, la gramática de los gráficos descompone un gráfico en sus componentes fundamentales y define cómo se combinan estos componentes para representar datos.

Estos componentes básicos son:

1.  **Datos (Data):** representan los datos que queremos visualizar.Puede ser una tabla de datos (data.frame) en R u otra fuente de datos.

2.  **Estética (Aesthetics):** definen cómo se mapean los atributos de los datos a propiedades visuales del gráfico, como posición en el eje X (`x`), posición en el eje Y (`y`), color, forma, tamaño, etc. Esto se especifica mediante la función `aes()` en `ggplot2`.

3.  **Geometría (Geometry):** representa la forma en que los datos se visualizan en el gráfico, como puntos, líneas, barras, áreas, etc. Cada tipo de gráfico tiene su función correspondiente en `ggplot2`, como `geom_point()` para un gráfico de dispersión o `geom_bar()` para un gráfico de barras.

4.  **Escala (Scale):** define cómo se mapean los valores de los datos a los valores visuales, como el rango de colores o el rango de los ejes. ggplot2 ajusta automáticamente las escalas, pero también puedes personalizarlas con funciones como ``` scale_log10(),``scale_x_continuous() ``` o `scale_color_manual()`.

5.   **Facetas (Facets):** permiten dividir los datos en subconjuntos y mostrarlos en paneles múltiples (facetas) según ciertas variables. Puedes usar `facet_wrap()` o `facet_grid()` en `ggplot2` para implementar esta funcionalidad.

6.   **Temas (Themes):** controlan la apariencia visual general del gráfico, como títulos, etiquetas de ejes, fondos, etc. Puedes personalizar el tema con la función `theme()` en `ggplot2`.


Por ejemplo, una estructura clásica de un gráfico de puntos será:

```{r, error = FALSE, eval = FALSE}
ggplot(data, # Los datos

   aes(x, y)) + # La estética

   geom_point()  # la geometría 
```



### 1.2: Ejemplos del uso de la gramática de gráficos con ggplot

Aquí vamos a ir explicando cómo puedes hacer uso de esta herramienta en tu computador. A medida que avanzas trata de ir replicando los ejercicios.

**NOTA:** Para hacer más versátil su uso, se recomienda conocer el funcionamiento del paquete `dplyr` y el uso de tuberías (pipes %>%), puedes repasar estos temas en la Unidad 1 de este módulo “Introducción a R y RStudio”. Por su parte, `ggplot2` está contenido dentro de la librería `Tidyverse`. Además, `Tidiverse` incluye otras librerías como `dplyr` que, a su vez, incluye las pipes `(%>%)`. Para más detalles sobre `Tidyverse` consulta la unidad de “Introducción a R y RStudio”.

Para los ejercicios prácticos de esta unidad es necesario cargar las siguientes librerías:

```{r, include = TRUE, message = FALSE, warning = FALSE, error = FALSE}
library(ggplot2)
```


```{r, include = TRUE, message = FALSE, warning = FALSE, error = FALSE}
library(tidyverse)
```


Ahora, veremos cada uno de los componentes para realizar gráficos de datos con `ggplot2` a través de un ejercicio práctico. Se requiere una tabla de datos (una estructura con filas y columnas) para poder ser usada en la estética de los gráficos. Previo al uso de `ggplot2`, suele ser necesario realizar un proceso de limpieza y organización de los datos. Para este ejercicio práctico usaremos una base de datos limpia, que nos permita hacer las visualizaciones sin la necesidad de pre-procesar los datos.

La tabla de datos para este ejercicio puedes encontrarla en: https://github.com/TRACE-LAC/TRACE-LAC-data/blob/main/otros/muestra_covid.RDS?raw=true

Cuando ya tengas los datos descargados en tu computador y en la carpeta de data de tu proyecto puedes ejecutar el siguiente comando:

```{r, error = FALSE, eval = TRUE}
covid19 <- readRDS("data/muestra_covid.RDS")
```

Una vez obtenida la tabla de datos vamos a explorar los datos para conocer el estado actual y revisar qué variables podríamos usar para las visualizaciones. Para esto utilizamos una de las funciones vistas en la unidad de “Introducción a R y RStudio” llamada glimpse.Úsala y verifica la estructura de la tabla de datos


```{r, error = FALSE, eval = TRUE}
glimpse(covid19)
```

Tras observar la estructura actual de la tabla de datos, se debe preguntar qué datos desea graficar.

## Tema 2: Estética (Aesthetics)

En el contexto de la gramática de los gráficos, la estética (aesthetics) se refiere a cómo mapeamos los atributos de nuestros datos a propiedades visuales en el gráfico. Estas propiedades visuales pueden ser elementos tales como la posición en el eje X (`x`), la posición en el eje Y (`y`), el color, la forma, el tamaño, etc. Al mapear estos atributos podemos crear visualizaciones que nos permiten comprender y comunicar patrones y relaciones en los datos de manera efectiva.

En `ggplot2` la función principal para especificar la estética es `aes().` Aquí hay algunos ejemplos para ilustrar cómo usar la estética en `ggplot2`:

**Ejemplo 1: Gráfico de dispersión (Scatter plot)**

Supongamos que tenemos una tabla de que cuenta con las variables `x` e `y`. Queremos crear un gráfico de dispersión donde la variable `x` se mapea en el eje X y la variable `y` en el eje Y. Además, queremos que los puntos se coloreen según la variable `grupo`. Mediante la función `aes()` de `ggplot2` es posible asignar estas variables a los correspondientes atributos visuales del gráfico, como veremos en el ejemplo a continuación.

Consideremos la base `covid19` que cargamos anteriormente. Imagine que requiere un gráfico de dispersión que muestre la incidencia de casos por fecha de reporte desagregados por sexo.Para esto, primero organizamos los datos para lograr una tabla resumen con la información que queremos graficar, usando `tidyverse` de la siguiente manera:

```{r include = TRUE, message = FALSE, warning = FALSE, error = FALSE}
covid19_resumen <- covid19 %>%
  group_by(fecha_reporte_web, sexo) %>%
  summarise(casos = n())

head(covid19_resumen) #muestra las primeras 6 filas
```

Luego, podemos usar la estética de los gráficos de `ggplot2` indicando las variables a usar en cada dimensión, en este caso en el eje *X* tendremos la variable de tiempo *(fecha_reporte_web)* y en el eje *Y* el número de casos *(casos)*. Para ver la desagregación por sexo haremos uso de uno de los atributos como el color. Estas instrucciones pueden seguirse a través del siguiente código:

```{r, eval = FALSE}
ggplot(
  data = covid19_resumen,
  aes(x = fecha_reporte_web, y = casos, color = sexo)
  ) +
  geom_point()
```

La visualización que generamos es la siguiente:

```{r, echo = FALSE, fig.align = 'center', out.width = '80%'}
ggplot(
  data = covid19_resumen,
  aes(x = fecha_reporte_web, y = casos, color = sexo)
  ) +
  geom_point()
```

## Tema 3: Geometría (Geometry)

La geometría representa la forma en que los datos se visualizan en el gráfico; como puntos, líneas, barras, áreas, etc. Cada tipo de gráfico tiene su función correspondiente en `ggplot2`, como `geom_point()` para un gráfico de dispersión o `geom_bar()` para un gráfico de barras.

En la siguiente tabla se muestran algunos ejemplos de los distintos tipos de gráficos soportados por `ggplot2` con su correspondiente comando:

| **Tipo de gráfica**              | **Geometría en ggplo2** |
|----------------------------------|-------------------------|
| Gráfica de barras                | geom_bar()              |
| Gráfico de columnas              | geom_col()              |
| Histograma                       | geom_hist()             |
| Gráfico de dispersión            | geom_point()            |
| Gráfico de dispersión con jitter | geom_jitter()           |
| Gráfico de líneas                | geom_line()             |
| Gráfico de cajas y bigotes       | geom_boxplot()          |
| Gráfico de densidad              | geom_density()          |
| Gráfico de violín                | geom_violin()           |
| Mapa de calor                    | geom_heatmap()          |
| Creación de mapas                | geom_sf()               |
| Línea de regresión               | geom_smooth()           |
| Gráfico de punto                 | geom_point()            |


### Ejemplo 2: Gráfico de líneas

Supongamos que queremos visualizar la evolución del número de casos de covid-19 a lo largo del tiempo. Para esto, primero debemos preparar el conjunto de datos que formarán el gráfico:

```{r include = TRUE, message = FALSE, warning = FALSE, error = FALSE}
covid19_fecha <- covid19 %>%
  group_by(fecha_reporte_web) %>%
  summarise(casos = n())

head(covid19_fecha) #muestra las primeras 6 filas
```

Una vez la tabla esté lista, procedemos a usar la geometría de `ggplot2`:

```{r, eval = FALSE}
ggplot(
  data = covid19_fecha, 
  aes(x = fecha_reporte_web, y = casos)
  ) +
  geom_line()
```

Y obtenemos el siguiente gráfico:
```{r, echo = FALSE, fig.align = 'center', out.width = '80%'}
ggplot(
  data = covid19_fecha, 
  aes(x = fecha_reporte_web, y = casos)
  ) +
  geom_line()
```



### Ejemplo 3: Gráfico de barras

Ahora, hagamos una visualización en forma de gráfico de barras del total de casos positivos por sexo, para esto utilizamos el comando `geom_bar()` así:

```{r, eval = TRUE, fig.align = 'center', out.width = '80%'}
ggplot(data = covid19) +
  geom_bar(aes(x = sexo))
```

En este ejemplo podemos observar que `ggplot2` automáticamente calcula el eje Y.



### Ejemplo 4. Gráfico de barras más complejo

Primero vamos a preparar los datos en una tabla de datos que permita contar el número de casos por departamentos:

```{r include = TRUE, message = FALSE, warning = FALSE, error = FALSE}
covid19_depto <- covid19 %>% 
  group_by(nombre_departamento) %>%
  summarise(casos = n())
```

Ahora, por medio de la geometría de ggplot, hacemos la visualización usando el argumento `stat = "identity"` que calcula la suma de la variable `y = casos` agrupando por la variable `x = nombre_departamento`:

```{r, eval=FALSE}
ggplot(data = covid19_depto, aes(x = nombre_departamento, y = casos)) + 
  geom_bar(stat = "identity")
```

Debes obtener la siguiente gráfica:
```{r, echo = FALSE, fig.align = 'center', out.width = '80%'}
ggplot(data = covid19_depto, aes(x = nombre_departamento, y = casos)) + 
  geom_bar(stat = "identity")
```


Podemos notar que no es posible ver bien los nombres de los departamentos. Para solucionar este problema, una alternativa es dar la vuelta a los ejes, usando al final el comando `coord_flip` de la siguiente manera:

```{r, eval=FALSE}
ggplot(data = covid19_depto, aes(x = nombre_departamento, y = casos)) +
  geom_bar(stat = "identity") +
  coord_flip()
```

Obteniendo como resultado:
```{r, echo = FALSE, fig.align = 'center', out.width = '80%'}
ggplot(data = covid19_depto, aes(x = nombre_departamento, y = casos)) +
  geom_bar(stat = "identity") +
  coord_flip()
```

Si queremos ordenar los paises por el número de casos, podemos utilizar el comando reorderen el eje donde está el departamento. La función reorder tiene dos argumentos: el primero es la variable a ordenar y el segundo es la variable que otorga el orden. En este caso sería `reorder(nombre_departamento, -casos)` si queremos ordenar de menor a mayor. El código sería el siguiente:

```{r, eval=FALSE}
ggplot(covid19_depto, 
       aes(x = reorder(nombre_departamento, -casos), y = casos)) +
  geom_bar(stat = "identity") +
  coord_flip()
```


Y la gráfica queda así:
```{r, echo = FALSE, fig.align = 'center', out.width = '80%'}
ggplot(covid19_depto, 
       aes(x = reorder(nombre_departamento, -casos), y = casos)) +
  geom_bar(stat = "identity") +
  coord_flip()
```


**Pregunta ¿cómo produciría el mismo gráfico pero en orden descendente?**



## Tema 4: Escala (Scale) 

En la gramática de los gráficos, la escala se refiere a cómo se mapean los valores de los datos a los valores visuales en el gráfico; es decir, cómo se representan los datos en la visualización. La elección adecuada de las escalas es esencial para que los gráficos sean interpretables y precisos.


A continuación, veremos algunos de los diferentes tipos de escalas disponibles en `ggplot2` y sus funciones:

1. Para **datos de tipo continuo o numéricos** tenemos **escalas continuas** como:
- scale_x_continuous() y scale_y_continuous() : para el eje x y el eje y, respectivamente.
- scale_color_continuous(): asigna colores a los valores continuos.
- scale_size_continuous(): asigna tamaño a los valores.

2. Para **datos categóricos** o de **carácter** tenemos **escalas discretas** como:
- scale_x_discrete() y scale_y_discrete(): para el eje x y el eje y, respectivamente.
- scale_color_discrete(): asigna colores a los valores discretos.
- scale_shape_discrete(): asigna diferentes formas a los diferentes valores discretos.

3. Para **datos de fecha** tenemos **escalas de fechas** como:
- scale_x_date() y scale_y_date(): para el eje x y el eje y, respectivamente cuando se tengan datos de fecha.

4. Para hacer uso de **escalas personalizadas** se hace uso de **escalas manuales** en las que podemos especificar nuestros propios valores.
- scale_color_manual(): se especifica manualmente los colores para los valores.
- scale_shape_manual(): se especifica manualmente las formas para los valores.

5. **Otras escalas:**
- scale_fill_*: se usa similar a las escalas de color pero para colores que queramos con relleno.
- scale_size_area(): Asigna los valores al área en lugar del diámetro, lo que puede ser útil para los puntos.
- scale_linetype(): para diferente tipos de línea
- scale_y_log10(): para hacer uso de escala logarítmica en eje y.
- scale_colour_gradient(): crea un degradé de color entre bajo y alto o scale_colour_gradient2() en bajo, medio y alto.


A continuación, veremos algunos ejemplos de cómo usar la escala en `ggplot2` con el `data.frame` `covid19`.



### Ejemplo 5. Gráfico de mapa de calor con escala logarítmica *`scale_y_log10()`*

Usamos exáctamente el mismo ejemplo anterior, pero en este caso al final agregamos la escala logarítmica *`scale_y_log10()`*

```{r}
ggplot(covid19_depto, aes(x = reorder(nombre_departamento, -casos), y = casos)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  scale_y_log10(name = "Casos Confirmados (escala log)")
```

**Por favor describa, ¿qué pasó en el ejercicio 5? ¿cuál es la diferencia con el ejercicio 4?**



## Tema 5: Facetas (Facets)

Las Facetas `(Facets)` en la gramática de los gráficos son una forma de dividir los datos en subconjuntos y representarlos en múltiples paneles dentro del mismo gráfico. Esto nos permite visualizar diferentes aspectos de los datos o comparar grupos de manera más efectiva. En `ggplot2`, podemos usar la función `facet_wrap()` o `facet_grid()` para implementar las facetas, dependiendo del número de variables a usar para la creación de los paneles.



### Ejemplo 6. Gráfico con facet wrap 

Primero vamos a preparar los datos en una tabla de datos que permita contar el número de casos por sexo:


```{r warning=FALSE}
covid19_sexo <- covid19 %>%
  group_by(edad, sexo) %>%
  summarise(casos = n())
```


Usando los datos de covid-19, vamos a representar la variable casos en dos paneles por sexo usando facet_wrap así:

```{r}
ggplot(data = covid19_sexo, aes(x = edad, y = casos)) +
  geom_point() +
  facet_wrap(~sexo)
```


De acuerdo a lo aprendido anteriormente, intentemos que cada faceta quede de un color diferente, es decir, asignando color a la varible sexo. ¿cómo cambiaría el código? El gráfico que debe producir es el siguiente:

```{r message=FALSE, warning=FALSE, echo=FALSE, include = TRUE}
ggplot(data = covid19_sexo, aes(x = edad, y = casos, colour = sexo)) +
  geom_point() +
  facet_wrap(~sexo)
```

## Tema 6: Tema (Theme)

En la gramática de los gráficos, el tema se refieren a la personalización de la apariencia visual general del gráfico, como los títulos, etiquetas de ejes, fondos, colores, tamaños de fuente, entre otros elementos. Con los temas, podemos mejorar la legibilidad y estética de los gráficos, asegurando que la información se comunique de
manera efectiva y atractiva.

En `ggplot2` podemos aplicar un tema predeterminado utilizando la función `theme()`. A continuación, proporcionamos algunos ejemplos de cómo utilizar los temas en `ggplot2` con la base de datos `covid19`.

Usando la misma gráfica anterior, comparemos dos temas:
`theme_classic()` y `theme_dark()`. Describa en sus propias palabras las
diferencias

**Ejemplo 6. Usando theme classic**

Para usar el tema clásico tenemos:

```{r warning=FALSE}
ggplot(data = covid19_sexo, aes(x = edad, y = casos)) +
  geom_point() +
  facet_wrap(~sexo)+
  theme_classic()
```

**Ejemplo 7. Usando theme classic**

```{r warning=FALSE}
ggplot(data = covid19_sexo, aes(x = edad, y = casos)) +
  geom_point() +
  facet_wrap(~sexo) +
  theme_dark()
```

Para revisar la lista de `theme()` que tiene disponible `ggplot2`, puede consultarse en <https://ggplot2.tidyverse.org/reference/ggtheme.html>

Finalmente, veamos un ejemplo de como modificar los themes manualmente.

**Ejemplo 8. Cambiando títulos, subtítulos y ejes**

Podemos usar comandos como `xlab`, `ylab` para cambiar los nombres de los ejes. Igualmente, comandos como `title` y `subtitle`.

```{r warning=FALSE}
ggplot(data = covid19_sexo, aes(x = edad, y = casos)) +
  geom_point() +
  facet_wrap(~sexo)+
  labs(
    y = "Tiempo de recuperacion en dias", x = "Edad en anios",
    colour = "Sexo",
    title = "Distribucion del tiempo de recuperacion de COVID-19 en Colombia"
  )
```

# Reto

Usando la base de datos `covid19` con la que hemos trabajado, intentemos recrear el siguiente gráfico en `ggplot`:

```{r include = TRUE, message = FALSE, warning = TRUE, error = TRUE, echo=FALSE}
covid19_fecha_sexo <- covid19 %>%
  group_by(fecha_reporte_web, sexo) %>%
  summarise(casos = n())


ggplot(
  data = covid19_fecha_sexo,
  aes(x = fecha_reporte_web, y = casos, colour = sexo)
) +
  geom_line() +
  scale_colour_viridis_d() +
  labs(
    y = "Numero de casos",
    x = "Fecha del reporte a SIVIGILA",
    colour = "Sexo",
    title = "Tendencia en el numero de casos COVID-19, 2020-2022"
  ) +
  theme_linedraw()
```

*Hemos llegado al final de la práctica `ggplot2`. ¡Muchas gracias por su participación!*

# Sobre este documento

*Contribuciones:* Zulma M. Cucunubá: primera versión
